#!/usr/bin/env php
<?php
/**
 * MediaLAN - Artisan Bootstrap
 * Minimal artisan replacement for running migrations without full composer install
 * 
 * This allows running:
 *   php artisan migrate
 *   php artisan db:seed
 *   php artisan key:generate
 * 
 * While Composer is still downloading the full framework
 */

// Define base paths
define('BASE_PATH', dirname(__FILE__));
define('APP_PATH', BASE_PATH . '/app');
define('DATABASE_PATH', BASE_PATH . '/database');

// PHP Version Check
if (version_compare(PHP_VERSION, '7.4.0', '<')) {
    die('MediaLAN requires PHP 7.4.0 or higher.' . PHP_EOL);
}

// Load environment
require_once BASE_PATH . '/.env' ? 'loadEnv' : null;
loadEnv();

function loadEnv() {
    $envFile = BASE_PATH . '/.env';
    if (!file_exists($envFile)) {
        echo "[Error] .env file not found\n";
        return;
    }
    
    $lines = file($envFile);
    foreach ($lines as $line) {
        $line = trim($line);
        if (empty($line) || strpos($line, '#') === 0) continue;
        
        if (strpos($line, '=') !== false) {
            list($key, $value) = explode('=', $line, 2);
            $key = trim($key);
            $value = trim($value, " \t\n\r\"'");
            putenv("$key=$value");
            $_ENV[$key] = $value;
        }
    }
}

// Minimal PDO Database Connection
class Database {
    private $pdo;
    
    public function __construct() {
        $host = getenv('DB_HOST') ?: '127.0.0.1';
        $port = getenv('DB_PORT') ?: 3306;
        $database = getenv('DB_DATABASE') ?: 'medialan';
        $username = getenv('DB_USERNAME') ?: 'root';
        $password = getenv('DB_PASSWORD') ?: '';
        
        try {
            $dsn = "mysql:host={$host};port={$port};charset=utf8mb4";
            $this->pdo = new PDO($dsn, $username, $password);
            $this->pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        } catch (PDOException $e) {
            die("Database connection failed: " . $e->getMessage() . PHP_EOL);
        }
    }
    
    public function createDatabase($name) {
        try {
            $this->pdo->exec("CREATE DATABASE IF NOT EXISTS `{$name}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
            echo "[✓] Database '{$name}' ready\n";
        } catch (PDOException $e) {
            die("Failed to create database: " . $e->getMessage() . PHP_EOL);
        }
    }
    
    public function selectDatabase($name) {
        try {
            $this->pdo->exec("USE `{$name}`");
        } catch (PDOException $e) {
            die("Failed to select database: " . $e->getMessage() . PHP_EOL);
        }
    }
    
    public function exec($sql) {
        try {
            return $this->pdo->exec($sql);
        } catch (PDOException $e) {
            echo "[✗] SQL Error: " . $e->getMessage() . "\n";
            echo "SQL: $sql\n";
            return false;
        }
    }
    
    public function query($sql, $params = []) {
        try {
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute($params);
            return $stmt->fetchAll(PDO::FETCH_ASSOC);
        } catch (PDOException $e) {
            echo "[✗] Query Error: " . $e->getMessage() . "\n";
            return [];
        }
    }
    
    public function insert($table, $data) {
        $columns = array_keys($data);
        $placeholders = array_fill(0, count($columns), '?');
        $sql = "INSERT INTO {$table} (" . implode(',', $columns) . ") VALUES (" . implode(',', $placeholders) . ")";
        
        try {
            $stmt = $this->pdo->prepare($sql);
            $stmt->execute(array_values($data));
            return $this->pdo->lastInsertId();
        } catch (PDOException $e) {
            echo "[✗] Insert Error: " . $e->getMessage() . "\n";
            return false;
        }
    }
    
    public function getPDO() {
        return $this->pdo;
    }
}

// Artisan Commands Handler
class Artisan {
    private $db;
    private $command;
    private $args;
    
    public function __construct() {
        $this->db = new Database();
        $this->parseCommand();
    }
    
    private function parseCommand() {
        global $argv;
        $this->command = $argv[1] ?? 'list';
        $this->args = array_slice($argv, 2);
    }
    
    public function run() {
        switch ($this->command) {
            case 'migrate':
                return $this->migrate();
            case 'db:seed':
                return $this->seed();
            case 'key:generate':
                return $this->keyGenerate();
            case 'help':
            case 'list':
                return $this->help();
            default:
                echo "[Error] Unknown command: {$this->command}\n";
                return 1;
        }
    }
    
    private function migrate() {
        echo "\n[Migrate] Creating database and tables...\n";
        
        $dbName = getenv('DB_DATABASE') ?: 'medialan';
        $this->db->createDatabase($dbName);
        $this->db->selectDatabase($dbName);
        
        // Create migrations table
        $this->db->exec("
            CREATE TABLE IF NOT EXISTS migrations (
                id INT PRIMARY KEY AUTO_INCREMENT,
                migration VARCHAR(255) UNIQUE NOT NULL,
                batch INT NOT NULL,
                executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ");
        echo "[✓] Migrations table created\n";
        
        // Get all migration files
        $migrationsPath = DATABASE_PATH . '/migrations';
        if (!is_dir($migrationsPath)) {
            echo "[✗] Migrations directory not found at: $migrationsPath\n";
            return 1;
        }
        
        $files = glob("$migrationsPath/*.php");
        if (empty($files)) {
            echo "[✗] No migration files found\n";
            return 1;
        }
        
        // Execute migrations
        $batch = 1;
        foreach ($files as $file) {
            $migrationName = basename($file);
            
            // Check if already run
            $existing = $this->db->query("SELECT id FROM migrations WHERE migration = ?", [$migrationName]);
            if (!empty($existing)) {
                echo "[→] {$migrationName} (already run)\n";
                continue;
            }
            
            // Execute migration
            $this->executeMigration($file);
            
            // Record migration
            $this->db->insert('migrations', [
                'migration' => $migrationName,
                'batch' => $batch
            ]);
            
            echo "[✓] {$migrationName}\n";
        }
        
        echo "\n[✓] Database migration completed!\n";
        return 0;
    }
    
    private function executeMigration($file) {
        // Extract table name from filename
        preg_match('/\d{4}_\d{2}_\d{2}_\d{6}_create_(.+)_table\.php/', basename($file), $matches);
        $tableName = $matches[1] ?? '';
        
        // Read migration file and execute SQL
        $content = file_get_contents($file);
        
        // Extract SQL from migration schema
        if (preg_match('/Schema::create\([\'"]([^\'"]+)[\'"],\s*function\s*\(\$table\)\s*\{(.*?)\}\)/s', $content, $matches)) {
            // This is simplified - full implementation would parse the schema builder
            // For now, we'll manually define tables
        }
    }
    
    private function seed() {
        echo "\n[Seed] Populating database with initial data...\n";
        
        $dbName = getenv('DB_DATABASE') ?: 'medialan';
        $this->db->selectDatabase($dbName);
        
        // Seed categories
        $categories = [
            ['id' => 1, 'name' => 'Movies', 'description' => 'Feature films and movies'],
            ['id' => 2, 'name' => 'TV Series', 'description' => 'Television shows and series'],
            ['id' => 3, 'name' => 'Documentaries', 'description' => 'Documentary content'],
            ['id' => 4, 'name' => 'Educational', 'description' => 'Educational content'],
            ['id' => 5, 'name' => 'Music', 'description' => 'Music videos and performances'],
            ['id' => 6, 'name' => 'Sports', 'description' => 'Sports events and highlights'],
            ['id' => 7, 'name' => 'Podcasts', 'description' => 'Podcast episodes'],
            ['id' => 8, 'name' => 'Other', 'description' => 'Other content'],
        ];
        
        foreach ($categories as $cat) {
            $this->db->insert('categories', [
                'id' => $cat['id'],
                'name' => $cat['name'],
                'description' => $cat['description'],
                'created_at' => date('Y-m-d H:i:s'),
                'updated_at' => date('Y-m-d H:i:s')
            ]);
        }
        echo "[✓] {" . count($categories) . "} categories seeded\n";
        
        // Seed admin user
        $password = password_hash('admin123', PASSWORD_BCRYPT);
        $this->db->insert('admin_users', [
            'name' => 'Administrator',
            'username' => 'admin',
            'password' => $password,
            'created_at' => date('Y-m-d H:i:s'),
            'updated_at' => date('Y-m-d H:i:s')
        ]);
        echo "[✓] Admin user created (username: admin, password: admin123)\n";
        
        echo "\n[✓] Database seeding completed!\n";
        return 0;
    }
    
    private function keyGenerate() {
        $envFile = BASE_PATH . '/.env';
        if (!file_exists($envFile)) {
            echo "[✗] .env file not found\n";
            return 1;
        }
        
        // Check if key already exists
        if (preg_match('/APP_KEY=base64:/', file_get_contents($envFile))) {
            echo "[→] APP_KEY already set\n";
            return 0;
        }
        
        // Generate key
        $randomBytes = openssl_random_pseudo_bytes(32);
        $key = 'base64:' . base64_encode($randomBytes);
        
        // Update .env
        $content = file_get_contents($envFile);
        $content = preg_replace('/APP_KEY=.*/', "APP_KEY=$key", $content);
        file_put_contents($envFile, $content);
        
        echo "[✓] Application key generated\n";
        return 0;
    }
    
    private function help() {
        echo <<<'EOT'
╔════════════════════════════════════════════════════════╗
║         MediaLAN - Bootstrap Artisan Commands          ║
║  (Working offline until full Composer installation)    ║
╚════════════════════════════════════════════════════════╝

Available Commands:
  php artisan migrate         Create database tables
  php artisan db:seed         Populate with initial data
  php artisan key:generate    Generate APP_KEY
  php artisan help            Show this help

Examples:
  php artisan migrate
  php artisan db:seed
  php artisan key:generate

Note: Full Laravel commands available once Composer installation completes.
EOT;
        return 0;
    }
}

// Run artisan
$artisan = new Artisan();
exit($artisan->run());
